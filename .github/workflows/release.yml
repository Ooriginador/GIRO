name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always

jobs:
  release:
    name: Build & Release
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: windows-latest
            target: x86_64-pc-windows-msvc
          - platform: ubuntu-22.04
            target: x86_64-unknown-linux-gnu

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"
          cache-dependency-path: pnpm-lock.yaml

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "tauri-build"

      - name: Install system dependencies (Linux)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            build-essential \
            curl \
            wget \
            file \
            libssl-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libudev-dev

      - name: Install dependencies (Monorepo)
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma Client
        working-directory: packages/database
        env:
          DATABASE_URL: "file:./mercearias.db"
        run: pnpm prisma generate

      - name: Build Frontend
        working-directory: apps/desktop
        run: pnpm build

      #      - name: Unit tests (Desktop)
      #        working-directory: apps/desktop
      #        run: pnpm run test:ci

      - name: Validate required secrets
        shell: bash
        run: |
          if [ -z "${{ secrets.GH_TOKEN }}" ]; then echo "GH_TOKEN (secret) is missing"; exit 1; fi
          if [ -z "${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}" ]; then echo "TAURI_SIGNING_PRIVATE_KEY (secret) is missing"; exit 1; fi
          if [ -z "${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}" ]; then echo "TAURI_SIGNING_PRIVATE_KEY_PASSWORD (secret) is missing"; exit 1; fi

      - name: Build Desktop App
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          LICENSE_API_KEY: ${{ secrets.LICENSE_API_KEY }}
        with:
          projectPath: apps/desktop
          tagName: ${{ github.ref_name }}
          releaseName: "GIRO ${{ github.ref_name }}"
          releaseBody: |
            ## üéâ Nova Vers√£o do GIRO

            ### üì• Downloads

            Escolha o instalador apropriado para o seu sistema operacional:

            | Plataforma | Arquivo | Descri√ß√£o |
            |------------|---------|-----------|
            | ü™ü Windows 64-bit | `.exe` | Instalador NSIS (Recomendado) |
            | ü™ü Windows 64-bit | `.msi` | Instalador MSI |
            | üêß Linux 64-bit | `.deb` | Debian/Ubuntu |
            | üêß Linux 64-bit | `.AppImage` | Universal Linux |

            ### ‚ú® O que h√° de novo

            Veja o [CHANGELOG](https://github.com/Ooriginador/GIRO/blob/main/CHANGELOG.md) para detalhes completos.

            ### üìñ Documenta√ß√£o

            - [Guia de Instala√ß√£o](https://ooriginador.github.io/GIRO)
            - [Documenta√ß√£o Completa](https://github.com/Ooriginador/GIRO/tree/main/docs)

            ### üîÑ Atualiza√ß√£o Autom√°tica

            Se voc√™ j√° tem o GIRO instalado, a atualiza√ß√£o ser√° detectada automaticamente na pr√≥xima vez que abrir o aplicativo.
          releaseDraft: false
          prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') }}
          includeUpdaterJson: true
